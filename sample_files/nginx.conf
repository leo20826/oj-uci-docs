###############################################
#  HTTP → HTTPS Redirect
###############################################
server {
    listen 80;
    listen [::]:80;

    server_name <DOMAIN>;

    # Redirect all HTTP traffic to HTTPS, uncomment as needed
    # return 301 https://$host$request_uri;
}


###############################################
#  Main HTTPS Server
###############################################
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    # Your domain name (no @, no protocol)
    # Example: server_name example.com www.example.com;
    server_name <DOMAIN>;

    ###################################################
    #  SSL Configuration (Let’s Encrypt or fullchain)
    ###################################################
    ssl_certificate     <SSL_FULLCHAIN_PATH>;
    ssl_certificate_key <SSL_PRIVKEY_PATH>;

    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;

    ###################################################
    # Cloudflare IP Forwarding
    # Uncomment if using Cloudflare proxy, also set real_ip_header below
    # Example: set_real_ip_from 192.168.0.0/16;
    ###################################################
    # real_ip_header CF-Connecting-IP;
    # set_real_ip_from 0.0.0.0/0;

    ###################################################
    #  Security Headers
    ###################################################
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header X-UA-Compatible "IE=Edge,chrome=1";

    client_max_body_size 10G;

    ###################################################
    #  Main Routing
    ###################################################
    charset utf-8;
    try_files $uri @icons;
    error_page 502 504 /502.html;

    # Static error/logo/robots
    # <SITE_ROOT> is repo clone directory
    # Example: ~/site
    location ~ ^/502\.html$|^/logo\.png$|^/robots\.txt$ {
        root <SITE_ROOT>;
    }

    #############################################
    #  Icon routing → uwsgi fallback
    #############################################
    location @icons {
        root <SITE_ROOT>/resources/icons;
        error_page 403 = @uwsgi;
        error_page 404 = @uwsgi;
    }

    #############################################
    #  uWSGI Backend
    #############################################
    location @uwsgi {
        uwsgi_read_timeout 600;
        uwsgi_pass unix:/tmp/dmoj-site.sock;   # matches uwsgi.ini
        include uwsgi_params;

        uwsgi_param SERVER_SOFTWARE nginx/$nginx_version;
        uwsgi_param Host $host;
        # Uncomment if using Cloudflare proxy to pass real IP
        # uwsgi_param X-Real-IP $http_cf_connecting_ip;
        # uwsgi_param X-Forwarded-For $http_cf_connecting_ip;
    }

    #############################################
    #  Static Files
    #############################################
    location /static/ {
        alias <SITE_ROOT>/static/;
        access_log off;
        log_not_found off;
        gzip_static on;
        expires max;
    }

    #############################################
    #  Media Files
    #############################################
    location /martor/ {
        alias <SITE_ROOT>/media/martor/;
    }

    location /pdf/ {
        alias <SITE_ROOT>/media/pdf/;
    }

    location /submission_file/ {
        alias <SITE_ROOT>/media/;
    }

    #############################################
    #  Optional Accelerated Downloads
    #############################################
    # Enable if needed, also set <CACHE_ROOT>
    # location /contestdatacache {
    #     internal;
    #     root <CACHE_ROOT>;
    # }

    # location /userdatacache {
    #     internal;
    #     root <CACHE_ROOT>;
    # }

    # location /pdfcache {
    #     internal;
    #     root <CACHE_ROOT>;
    # }

    #############################################
    #  WebSocket Event Server
    #############################################
    location /event/ {
        proxy_pass http://127.0.0.1:<EVENT_WS_PORT>/;
        # Default port is 15100
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
    }

    location /channels/ {
        proxy_pass http://127.0.0.1:<EVENT_HTTP_PORT>;
        # Default port is 15101
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location /poll/ {
        proxy_pass http://127.0.0.1:<EVENT_POLL_PORT>;
        # Default port is 15102
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }


    #############################################
    #  Logging
    #############################################
    error_log  /var/log/nginx/<SERVICE_NAME>_error.log;
    access_log /var/log/nginx/<SERVICE_NAME>_access.log;
}
